package ex9;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.ServerSocket;
import java.net.Socket;

public class ListenRunnable implements Runnable {

	int port;
	ServerSocket server;
	DistributedTextEditor dte;
	Socket incoming;
	ObjectInputStream input;
	boolean notInterrupted;

	public ListenRunnable(int port, DistributedTextEditor dte){
		this.port = port;
		this.dte = dte;
	}

	//Calls the disconnect method in Event Replayer if the connection is not closed.
	public void disconnect(){
		if(incoming!=null){
			if(!incoming.isClosed()){
				System.out.println("SERVER - Trying to disconnect incoming connection");
				dte.disconnectER();
			}
		}
	}

	@Override
	public void run() {
		try {
			server = new ServerSocket(port);
			server.setReuseAddress(true);

			dte.setTitle("Listening on " +
					server.getInetAddress().getLocalHost() + 
					server.getLocalPort());

			while(true){
				dte.setTitle("Listening on " +
						server.getInetAddress().getLocalHost() + 
						server.getLocalPort());
				incoming = server.accept();
				System.out.println("SERVER - START Incoming connection");
				dte.setConnection(incoming);
				dte.setTitle("Connected with client");
				dte.clearFields();
				while(!incoming.isClosed()){
					
				}
				System.out.println("SERVER - END Incoming connection");
				dte.clearFields();
			}

		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
}
